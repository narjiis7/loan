<script>
  let authCode = '';
  let token = '';

  // 1. Authentication
  async function authenticate() {
    try {
      const res = await my.getAuthCode({ scopes: ['auth_base', 'USER_ID'] });
      authCode = res.authCode;
      console.log("AuthCode:", authCode); // ðŸ‘€ Ø§Ø·Ø¨Ø¹ÙŠ Ø§Ù„ÙƒÙˆØ¯
      document.getElementById('authCode').textContent = authCode;

      const response = await fetch('https://its.mouamle.space/api/auth-with-superQi', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: authCode })
      });

      const data = await response.json();
      console.log("Auth Response:", data); // ðŸ‘€ Ø´ÙˆÙÙŠ Ø§Ù„Ø±Ø¯ ÙƒØ§Ù…Ù„
      token = data.token;
      document.getElementById('token').textContent = token;

      my.alert({ content: "Login successful" });
    } catch (err) {
      console.error("Auth Error:", err);
      my.alert({ content: "Login failed: " + JSON.stringify(err) });
    }
  }

  // 2. Payment
  async function pay() {
    try {
      const response = await fetch('https://its.mouamle.space/api/payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token // âœ… Ø¬Ø±Ø¨ÙŠ ØµÙŠØºØ© Bearer
        }
      });

      const data = await response.json();
      console.log("Payment Response:", data); // ðŸ‘€ Ø§Ø·Ø¨Ø¹ÙŠ Ø§Ù„Ø±Ø¯

      if (!data.url) {
        my.alert({ content: "Payment failed: no URL returned" });
        return;
      }

      await my.tradePay({
        paymentUrl: data.url,
        success: () => my.alert({ content: "Payment successful" }),
        fail: (err) => {
          console.error("TradePay Error:", err);
          my.alert({ content: "Payment failed: " + JSON.stringify(err) });
        }
      });
    } catch (err) {
      console.error("Payment Error:", err);
      my.alert({ content: "Payment failed: " + JSON.stringify(err) });
    }
  }

  // 3. QR Scanner
  async function showQR() {
    try {
      const res = await my.scan({ type: 'qr' });
      console.log("QR Result:", res); // ðŸ‘€ Ø§Ø·Ø¨Ø¹ÙŠ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù€ QR
      my.alert({ content: "Scanned QR: " + res.code });
    } catch (err) {
      console.error("QR Error:", err);
      my.alert({ content: "Scan failed: " + JSON.stringify(err) });
    }
  }

  // Event Listeners
  document.getElementById('loginBtn').addEventListener('click', authenticate);
  document.getElementById('payBtn').addEventListener('click', pay);
  document.getElementById('qrBtn').addEventListener('click', showQR);
</script>