<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Page</title>

    <script src="https://cdn.marmot-cloud.com/npm/hylid-bridge/2.10.0/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="bg-gray-100">

    <div class="h-16 w-full bg-stone-700 flex items-center px-4 fixed top-0">
        <h1 class="text-xl text-white font-bold">Authentication</h1>
    </div>

    <div class="pt-24 flex flex-col items-center gap-4">

        <button
            class="bg-blue-500 text-white px-6 py-2 rounded-md"
            onclick="authenticate()">
            Login
        </button>

        <p class="text-sm">
            Auth Code:
            <span id="authCode" class="font-mono"></span>
        </p>

    </div>

    <script>
        function authenticate() {
            my.getAuthCode({
                scopes: ['auth_base', 'USER_ID'],
                success: (res) => {

                    const authCode = res.authCode;
                    document.getElementById('authCode').textContent = authCode;

                    fetch('https://its.mouamle.space/api/auth-with-superQi', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: authCode })
                    })
                    .then(res => res.json())
                    .then(data => {
                        // tradeNO جاي من الباك إند
                        const tradeNO = data.tradeNO;

                        if (!tradeNO) {
                            my.alert({ content: 'No trade number received' });
                            return;
                        }

                        // خزّن tradeNO وانتقل لصفحة الدفع
                        localStorage.setItem('tradeNO', tradeNO);

                        my.navigateTo({
                            url: '/payment.html'
                        });
                    });
                }
            });
        }
    </script>

</body>
</html>
